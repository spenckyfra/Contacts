////
Howto:
- Write this document such that it helps people to migrate. Describe what they should do.
- Chronological order is not necessary.
- Choose the right top level chapter (java, js, other)
- Use "WARNING: {NotReleasedWarning}" on its own line to mark parts about not yet released code (also add a "(since <version>)" suffix to the chapter title)
- Use "title case" in chapter titles (https://english.stackexchange.com/questions/14/)
////

ifndef::finaldoc[]
include::../_initDoc.adoc[]
endif::finaldoc[]

// double underscore
:dus: __

== About This Document

This document describes all relevant changes *from Eclipse Scout {scout-previous-version} to Eclipse Scout {scout-version}*. If existing code has to be migrated, instructions are provided here.

== Obtaining the Latest Version

=== Scout Runtime for Java

Scout Runtime artifacts for Java are distributed using Maven Central:

* {maven-central-link} on _Maven Central_
* {mvnrepository-link} on _mvnrepository.com_

Usage example in the parent POM of your Scout application:

[source,xml]
[subs="verbatim,attributes"]
----
<dependency>
    <groupId>org.eclipse.scout.rt</groupId>
    <artifactId>org.eclipse.scout.rt</artifactId>
    <version>{maven-version}</version>
    <type>pom</type>
    <scope>import</scope>
</dependency>
----

=== Scout Runtime for JavaScript

Scout Runtime artifacts for JavaScript are distributed using npm:

* https://www.npmjs.com/package/@eclipse-scout/core[Scout Core Runtime]
* https://www.npmjs.com/search?q=%40eclipse-scout[All official Scout JavaScript packages]

Usage example in your package.json:

[source,json]
[subs="verbatim,attributes"]
----
{
  "name": "my-module",
  "version": "1.0.0",
  "dependencies": {
    "@eclipse-scout/core": "{node-version}",
    "jquery": "3.5.1"
  }
}
----

The pre-built Scout JavaScript assets are also available using a CDN (e.g. to be directly included in a html document):
https://www.jsdelivr.com/package/npm/@eclipse-scout/core?path=dist

=== IDE Tooling (Scout SDK)

Scout officially supports https://www.jetbrains.com/idea/[IntelliJ IDEA] and {scout-sdk-download-link}.

==== IntelliJ IDEA

You can download the Scout plugin for IntelliJ IDEA from the https://plugins.jetbrains.com/plugin/13393-eclipse-scout/[JetBrains Plugin Repository] or you can use the plugins client built into IntelliJ IDEA.
Please refer to the https://www.jetbrains.com/help/idea/managing-plugins.html[IntelliJ Help] on how to install and manage plugins.

==== Eclipse

You can download the complete Eclipse IDE with Scout SDK included here: +
{scout-sdk-download-link}

To install the Scout SDK into your existing Eclipse IDE, use this P2 update site: +
{scout-sdk-update-site}

== New 3rd Party requirements

The Java 8 support has been dropped in Scout 22. Therefore, only Java 11 is supported at the moment.
To update your application the following steps might be required:

* Update the version of the `maven_rt_plugin_config-master` in your `pom.xml` files to the latest `3.15.x` release. See https://search.maven.org/classic/#search%7Cgav%7C1%7Cg%3A%22org.eclipse.scout%22%20AND%20a%3A%22maven_rt_plugin_config-master%22[Maven central] for a list of versions available.
* Update the Scout versions (`package.json` and `pom.xml`) as shown in <<Obtaining the Latest Version>>.
* Ensure you have at least Maven 3.6.3 installed. Older versions will no longer work.
* Ensure you have Java 11 installed. Other versions will not work.
* In case you have set one of the following properties in your `pom.xml` files, update its value to `11`:
** `jdk.source.version`
** `jdk.min.version`
** `maven.compiler.source`
** `maven.compiler.target`
** `maven.compiler.release`
* In case you used the `cargo-maven2-plugin` replace it with the `cargo-maven3-plugin`.
* If you are using Eclipse and web-service providers, update the `.factorypath` files as shown in the `JAX-WS Appendix` of the Scout documentation.

== @TypeVersion Annotation Type Change

The type version of a data object is used to identify a certain structure version of the stored data object.
A data object may be stored in a database or be available as a container to export certain data for import in a different compatible system.
Such a data object may evolve over time and undergo structural changes.
Some structural changes make it necessary to apply migrations to existing serialized data objects to comply with the new structure.

In order to prepare for migration support, the value type of the `@TypeVersion` annotation was changed from `String` to `Class<? extends ITypeVersion>`.
A _ITypeVersion_ represents a namespace/version and its dependencies.

*Migration:*

For each different String value used in type version annotation, create an implementation of `ITypeVersion` as described
in <<../technicalGuide/DataObject.adoc#cha-namespace-and-itypeversion,Data Objects: Namespace and ITypeVersion>> in the technical documentation.

`DataObjectInventory#getTypeVersion` now returns `NamespaceVersion` instead of `String`.
Use `NamespaceVersion#unwrap` to access the text representation.

== Annotation @EnumVersion Removed

`@EnumVersion` was designed for migration support similar as the TypeVersion but was never part of any serialization output of a data object,
therefore couldn't be used as indicator for migrations.
Support for `@EnumVersion` was removed.

*Migration:*

Remove `@EnumVersion` annotations on `IEnum` implementors.

== Native Notification Support

The new notifications displayed by the browser use the application logo configured in `AbstractDesktop#getConfiguredLogoId()` by default.

If you use native notifications, you should provide a logo with a resolution of at least 150x150 px.
If your application logo already has such a resolution, it should be fine.
If your application logo has a lower resolution or is an SVG, you should use a different image for the notifications (SVGs are not supported by Chrome notifications).
To do so, just configure the native notification defaults on your desktop.

[source,java]
[subs="verbatim,attributes"]
----
@Override
protected NativeNotificationDefaults getConfiguredNativeNotificationDefaults() {
  return super.getConfiguredNativeNotificationDefaults()
    .withIconId("notification_logo.png");
}
----

== Application Logo / Info Form

The image `application_logo_large` and the constant `AbstractIcons.ApplicationLogo` have been removed.
The name was confusing and it was only used for the `ScoutInfoForm`.
The info form now uses the logo of the desktop (`IDesktop#getLogoId())` by default.
So if you prefer to use a different logo for the info form, just extend the info form, override the method `getProductLogo()` and return the name of your preferred image.

In case you don't use SVG logos yet, you should consider doing so to prevent blurry logos.

== Style
=== LESS Variables

- @active-inverted-background-color -> @selected-background-color
- @active-inverted-color -> @selected-color
- @navigation-background-color -> @desktop-navigation-background-color
- @navigation-color -> @desktop-navigation-color
- @outline-title-margin-left/right -> @outline-title-padding-left/right
- @group-box-title-margin-top -> @group-box-header-margin-top
- @group-box-title-border-width -> @group-box-header-border-width

Notes:
@desktop-navigation-background-color now points to @desktop-header-background-color;
Instead of customizing the navigation background color it is suggested to now customize the header background color.

=== Rules
- .menubox -> .menubar-box
- .group-box-title -> .group-box-header > .title
- border-bottom of group-box-title -> .group-box-header > .bottom-border
- .tab-box-bottom-border -> .bottom-border

// TODO cgu describe: button, menu styles

=== Icons
==== Cleanup

Some icons have been removed because they are not used by Scout itself anymore.
If you need these icons, please add them to your own icon library.
If you don't already have a custom icon library, please see our guide on how to create one:
https://eclipsescout.github.io/11.0/technical-guide.html#icons
The icons from Scout can be found here: https://github.com/eclipse-scout/scout.rt/tree/releases/11.0/org.eclipse.scout.rt.ui.html/src/icons
There you also find a `selection.json` that can be used to import the icons to https://icomoon.io/app[IcoMoon].

- MENU_BOLD (uF0C9)
- LIST_UL_BOLD (uF0CA)
- LIST_OL_BOLD (uF0CB)
- GRAPH_BOLD (uE023)
- CATEGORY (uE059)
- CATEGORY_BOLD (uE024)
- ELLIPSIS-V-BOLD / VERTICAL_DOTS (uE040)
- SPINNER (uE044)
- ANGLE-DOUBLE-LEFT-BOLD (uF100)
- ANGLE-DOUBLE-RIGHT-BOLD (uF101)
- ANGLE-DOUBLE-UP-BOLD (uF102)
- ANGLE-DOUBLE-DOWN-BOLD (uF103)
- BOLD (uE051)
- ITALIC (uE052)
- UNDERLINE (uE053)
- STRIKETHROUGH (uE054)
- LIST-UL (uE055)
- LIST-OL (uE056)
- LIGHTBULB_OFF (uE057)
- LIGHTBULB_ON (uE058)

The following icons have been renamed
- EXCLAMATION_MARK -> EXCLAMATION_MARK_BOLD

==== Line Width Adjustments
The line width of the Scout icons has been increased a little because they are now displayed a little smaller.
If you use custom icons in combination with the Scout icons, you may want to consider adjusting the line widths of your icons as well.
This should only be relevant if you explicitly used the Scout icons in your code.

Also, the Scout icons now come with a regular and a light font.
The regular font should be used if the icon is displayed at about 16px.
This is the case for most widgets (menu, button etc.)
If the icon is displayed larger, the light font can be used.
To activate it for your custom widget, set the font-weight to @icon-font-weight-light.

If you want to align your custom icons with the Scout icons, use the following dimensions:

* Regular: 1.5px line width and 24px artboard height
* Light: 1px line width and 24px artboard height

== Browser Field

The type of the `data` argument for the callback `execPostMessage` was changed from _String_ to _Object_.
This allows for the widest variety of data that can be sent from an embedded page to the application:

* String
* Number
* Boolean
* IDataObject (objects or arrays)

In previous Scout versions, all messages were always converted to text.
Now, the data type is preserved as accurately as possible.
JSON objects or arrays are converted to IDoEntity or DoList with the help of the IObjectMapper bean.
To use this feature, an implementation of IDataObjectMapper needs to be present at runtime.
If no implementation is available, the data will be converted to text automatically.

*Migration:*

Adjust the signature of all implementations of `AbstractBrowserField#postMessage` in your code.

* Change `execPostMessage(String data, String origin)` to `execPostMessage(Object data, String origin)`.
* If the message sent by the embedded web page is not a text, the appropriate data type is now passed.
Check the expected type using `instanceof` or convert it to String manually.
* If you want objects and arrays to be converted to IDataObjects automatically, make sure there is an
implementation of IObjectMapper present at runtime, e.g. by adding a dependency to the module
_org.eclipse.scout.rt.jackson_ in pom.xml.

== Lazy Creation of detailTable and detailForm in Scout JS Pages

In the past when a page was created the embedded detail forms and tables have been created together with the page.
This may lead to a bad performance when an outline containing lots of complex pages is created.

Therefore the containing tables and forms are now only created when the page is activated (e.g. selected by the user).
This is the same behavior as already implemented in Scout Classic since several years.
As a consequence accessing `Page.detailForm` or `Page.detailTable` may now return `null` if the page has not been activated yet.

Check all usages of the `detailForm` and `detailTable` properties of pages in your code and ensure it is guarded with a null check or is only executed when the page has already been activated.

Typically these properties are accessed in the `_init()` function of a page e.g. to attach listeners.
This is no longer possible as these properties are no longer available at that moment.

As an alternative override the `_initDetailForm(form)` or `_initDetailTable(table)` methods if your code exists on a Page (don't forget to add a super call).
If outside a Page listen for the `propertyChange` events for `detailForm` or `detailTable` to execute your detailForm or detailTable dependant code.

Furthermore if you use the following methods on pages, please rename them as follows:

* from `createDetailForm` to `_createDetailForm`
* from `_createTable` to `_createDetailTable`
* from `_initTable` to `_initDetailTable`
* from `_ensureDetailForm` to `ensureDetailForm`

== Jackson DoEntity Deserializer

The following classes were renamed:

* IDoEntityDeserializerTypeResolver -> IDoEntityDeserializerTypeStrategy
* DefaultDoEntityDeserializerTypeResolver -> DefaultDoEntityDeserializerTypeStrategy
* RawDoEntityDeserializerTypeResolver -> RawDoEntityDeserializerTypeStrategy

== Deprecated Functions in strings.js Utility

The static `strings` utility provides various string-related functions.
The obsolete functions `uppercaseFirstLetter` and `lowercaseFirstLetter` were deprecated in favor of more robust and consistent alternatives, and should no longer be used.
They will be removed eventually.

*Migration:*

* Change `strings.uppercaseFirstLetter(s)` to `strings.toUpperCaseFirstLetter(s)`.
* Change `strings.lowercaseFirstLetter(s)` to `strings.toLowerCaseFirstLetter(s)`.

Note the uppercase "C" in the new function names!

TIP: At the same time, some new null-safe variants of `String` prototype methods were added: `toUpperCase(s)`, `toLowerCase(s)`, `length(s)`, `trim(s)` .

== New Style for Tooltips

The style and colors for tooltips has been changed which may require the following migration:

. The colors for tooltips have changed: severity `OK` is showing in green, `INFO` in black and `WARNING` in orange. Severity `ERROR` is still red and therefore remains unchanged. If you use a `Status` that is displayed as tooltip and uses one of the changed severities, verify if the color matches the meaning of the tooltip and adapt the severity if necessary.
. Scout JS only: The tooltips are now displayed in inverse style (white text, dark background). If you used custom styling for your tooltips (using property `htmlEnabled`), you might require to adapt your styles to look nice again with the inverse style.

== Logging the HTTP Session ID

The HTTP Session ID is a crucial factor of a web application's security.
Knowledge of the session ID can enable attackers to hijack the session of an active user.
It must therefore not be made available to a malicious third party under any circumstances!
Writing the ID to a log files _might_ therefore pose a security risk, depending on who has access to the file.

Scout does not directly output the HTTP Session ID by default, but it provides a corresponding "diagnostics context value" (http://www.slf4j.org/apidocs/org/slf4j/MDC.html[MDC]).
If the logger implementation is configured accordingly, the context value `http.session.id` is written to the log file.

In accordance with the _security by default_ principle, the diagnostics context value no longer contains the full session ID.
Instead, an obfuscated and truncated identifier is provided.
It cannot be converted back to the original session ID but is still sufficiently unique to relate log entries for the same session for debugging purposes.
See the class `HttpSessionIdLogHelper` for details.

*Migration:*

* No migration is required.
* Logger configurations that don't use the MDC value `http.session.id` are not affected by this change.
* The content of the MDC value `http.session.id` can be configured via the system property _scout.diagnostics.httpSessionIdLogMode_.
** `SHORT`: Provides a safe, truncated session identifier. This is the default value (no configuration required).
** `OFF`: Never provides a value (always empty).
** `FULL`: Provides the full HTTP Session ID. This restores the previous, less safe behavior. *Using this value is NOT recommended!*
